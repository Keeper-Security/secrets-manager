name: Publish to Crates.io (Rust SDK)

on:
  workflow_dispatch:

jobs:
  test-rust-sdk:
    name: Test Rust SDK (${{ matrix.rust }})
    permissions:
      contents: read
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        rust:
          - '1.87'  # Minimum (Edition 2024 + is_multiple_of support)
          - 'stable'  # Latest stable

    defaults:
      run:
        working-directory: ./sdk/rust

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run Clippy
        run: cargo clippy --all-features -- -D warnings

      - name: Run lib tests
        run: cargo test --all-features --lib

      - name: Run integration tests
        run: |
          cargo test --all-features --test folder_operations_tests
          cargo test --all-features --test file_operations_tests
          cargo test --all-features --test error_handling_tests
          cargo test --all-features --test regional_hostname_tests
          cargo test --all-features --test create_secret_test
          cargo test --all-features --test crypto_tests
          cargo test --all-features --test delete_secret_tests
          cargo test --all-features --test feature_validation_tests
          cargo test --all-features --test get_secrets_tests
          cargo test --all-features --test integration_tests
          cargo test --all-features --test notation_tests
          cargo test --all-features --test payload_test
          cargo test --all-features --test totp_test
          cargo test --all-features --test update_secret_tests

      - name: Run caching tests (serial execution required)
        run: cargo test --all-features --test caching_tests -- --test-threads=1

      - name: Build release
        run: cargo build --release

  generate-sbom:
    name: Generate SBOM
    needs: test-rust-sdk
    permissions:
      contents: read
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./sdk/rust

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Detect Rust SDK version
        id: detect-version
        run: |
          echo "Detecting Rust SDK version..."
          if [ -f "Cargo.toml" ]; then
            VERSION=$(grep -Po '^version\s*=\s*"\K[^"]*' Cargo.toml)
            echo "Detected version: ${VERSION}"
          else
            VERSION="1.0.0"
            echo "Could not detect version, using default: ${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Install Syft and Manifest CLI
        run: |
          echo "Installing Syft v1.18.1..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /tmp/bin v1.18.1
          echo "/tmp/bin" >> $GITHUB_PATH

          echo "Installing Manifest CLI v0.18.3..."
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b /tmp/bin v0.18.3

      - name: Generate and publish SBOM
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
          PROJECT_VERSION: ${{ steps.detect-version.outputs.version }}
        run: |
          echo "Creating Syft configuration for Rust scanning..."
          cat > syft-config.yaml << 'EOF'
          package:
            search:
              scope: all-layers
            cataloger:
              enabled: true
              java:
                enabled: false
              python:
                enabled: false
              nodejs:
                enabled: false
              rust:
                enabled: true
          EOF

          echo "Generating SBOM with Manifest CLI..."
          manifest sbom . \
            --generator=syft \
            --name=keeper-secrets-manager-rust-sdk \
            --version=${PROJECT_VERSION} \
            --output=spdx-json \
            --file=rust-sdk-sbom.json \
            --api-key=${MANIFEST_TOKEN} \
            --publish=true \
            --asset-label=application,sbom-generated,rust,cargo,secrets-manager \
            --generator-config=syft-config.yaml

          echo "SBOM generated and uploaded successfully: rust-sdk-sbom.json"

      - name: Archive SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-rust-sdk-${{ steps.detect-version.outputs.version }}
          path: ./sdk/rust/rust-sdk-sbom.json
          retention-days: 90

  dry-run-publish:
    name: Validate package (dry-run)
    environment: test
    needs: [test-rust-sdk, generate-sbom]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: ./sdk/rust

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Authenticate with crates.io via OIDC
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Dry-run publish (validates package and authentication)
        run: |
          cargo package --allow-dirty
          cargo publish --dry-run
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-crates:
    name: Publish Rust SDK to crates.io
    environment: prod
    needs: [dry-run-publish]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: ./sdk/rust

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Authenticate with crates.io via OIDC
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to crates.io
        run: cargo publish --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
