name: Reusable Maven Central Publishing

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the Java project'
        required: true
        type: string
      project-name:
        description: 'Project name for SBOM generation'
        required: true
        type: string
      project-title:
        description: 'Human readable project title'
        required: true
        type: string
      java-version:
        description: 'Java version to use for building'
        required: false
        type: string
        default: '11'

jobs:
  get-version:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      artifact-id: ${{ steps.extract-version.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v3
      - name: Extract version and artifact ID from Gradle
        id: extract-version
        run: |
          VERSION=$(grep -Po 'version\s*=\s*"\K[^"]*' build.gradle.kts || echo "0.0.0-unknown")
          echo "Version retrieved: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract artifactId from settings.gradle.kts (rootProject.name)
          if [ -f "settings.gradle.kts" ]; then
            ARTIFACT_ID=$(grep -Po 'rootProject\.name\s*=\s*"\K[^"]*' settings.gradle.kts || echo "")
          fi

          # Fallback to settings.gradle if settings.gradle.kts doesn't exist
          if [ -z "$ARTIFACT_ID" ] && [ -f "settings.gradle" ]; then
            ARTIFACT_ID=$(grep -Po "rootProject\.name\s*=\s*['\"]\\K[^'\"]*" settings.gradle || echo "")
          fi

          # Final fallback to project-name input
          if [ -z "$ARTIFACT_ID" ]; then
            ARTIFACT_ID="${{ inputs.project-name }}"
          fi

          echo "Artifact ID retrieved: $ARTIFACT_ID"
          echo "artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT

  generate-and-upload-sbom:
    needs: get-version
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build project and copy dependencies
        run: |
          echo "Building project to resolve dependencies..."
          ./gradlew build -x test --no-daemon --refresh-dependencies

          echo "Copying runtime dependencies for SBOM scanning..."
          ./gradlew copyDependencies

          echo "Dependencies collected:"
          ls -la build/sbom-deps/ || echo "Warning: sbom-deps directory not created"

          echo "Excluding fatJar from SBOM (test artifact only):"
          find build/libs -name "*.jar" -type f ! -name "*-fat.jar" || true

      - name: Install SBOM tools
        run: |
          echo "Installing Syft v1.18.1..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.18.1

          echo "Installing Manifest CLI v0.18.3..."
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b . v0.18.3
          chmod +x ./manifest

          echo "Verifying installations..."
          syft version
          ./manifest --version

      - name: Generate and publish SBOM
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
        run: |
          echo "Creating Syft configuration for Java/Kotlin scanning..."
          cat > syft-config.yaml << 'EOF'
          package:
            search:
              scope: all-layers
              unindexed-archives: true
              indexed-archives: true
            cataloger:
              enabled: true
              java:
                enabled: true
                search-unindexed-archives: true
                search-indexed-archives: true
                resolve-dependencies: true
                use-network: false
                max-parent-recursive-depth: 10
              # Disable non-Java catalogers
              ruby:
                enabled: false
              python:
                enabled: false
              nodejs:
                enabled: false
              dotnet:
                enabled: false
              golang:
                enabled: false
          EOF

          echo "Generating SBOM with Manifest CLI..."
          ./manifest sbom build/sbom-deps \
            --generator=syft \
            --generator-config=syft-config.yaml \
            --name=${{ inputs.project-name }} \
            --version=${{ needs.get-version.outputs.version }} \
            --output=spdx-json \
            --file=sbom.json \
            --api-key=${MANIFEST_TOKEN} \
            --publish=true \
            --asset-label=application,sbom-generated,java,sdk,maven,security

      - name: Archive SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ inputs.project-name }}-${{ needs.get-version.outputs.version }}
          path: ${{ inputs.working-directory }}/sbom.json
          retention-days: 90

  publish-to-maven-central:
    needs: [get-version, generate-and-upload-sbom]
    environment: prod
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Get the source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Retrieve secrets from KSM
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@v1
        with:
          keeper-secret-config: ${{ secrets.KSM_ARTIFACT_JAVA_APP_CONFIG }}
          secrets: |
            IR14oITcuvFr9Ek-lKVrXw/custom_field/signing.password > env:JRELEASER_GPG_PASSPHRASE
            IR14oITcuvFr9Ek-lKVrXw/file/90A46CD1-private-key.asc > file:/tmp/private-key.asc
            IR14oITcuvFr9Ek-lKVrXw/file/90A46CD1-public-key.asc > file:/tmp/public-key.asc
            IR14oITcuvFr9Ek-lKVrXw/custom_field/centralUsername > env:JRELEASER_MAVENCENTRAL_USERNAME
            IR14oITcuvFr9Ek-lKVrXw/custom_field/centralPassword > env:JRELEASER_MAVENCENTRAL_PASSWORD

      - name: Set up Java ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Build and test
        run: ./gradlew clean build test

      - name: Publish to staging directory
        run: ./gradlew publish

        # Signing docs: https://jreleaser.org/guide/latest/reference/signing.html
      - name: Deploy to Maven Central via JReleaser
        run: ./gradlew jreleaserDeploy --no-configuration-cache --stacktrace
        env:
          JRELEASER_GPG_PASSPHRASE: ${{ env.JRELEASER_GPG_PASSPHRASE }}
          JRELEASER_GPG_SECRET_KEY: /tmp/private-key.asc
          JRELEASER_GPG_PUBLIC_KEY: /tmp/public-key.asc
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ env.JRELEASER_MAVENCENTRAL_USERNAME }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ env.JRELEASER_MAVENCENTRAL_PASSWORD }}

      - name: Verify publication via Central Portal API
        run: |
          GROUP_ID="com.keepersecurity.secrets-manager"
          ARTIFACT_ID="${{ needs.get-version.outputs.artifact-id }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          GROUP_PATH="${GROUP_ID//./\/}"

          echo "Verifying publication for: ${GROUP_ID}:${ARTIFACT_ID}:${VERSION}"

          # Check if JReleaser output.properties exists and contains deployment ID
          JRELEASER_OUTPUT="build/jreleaser/output.properties"

          if [ -f "$JRELEASER_OUTPUT" ]; then
            echo "Reading JReleaser output properties..."
            cat "$JRELEASER_OUTPUT"

            # Extract deployment ID (supports both formats: deploy.maven.mavenCentral.*.deploymentId or deployMavenCentral*DeploymentId)
            DEPLOYMENT_ID=$(grep -E "(deploy\.maven\.mavenCentral.*deploymentId|deployMavenCentral.*DeploymentId)" "$JRELEASER_OUTPUT" | cut -d'=' -f2 | tr -d '[:space:]')

            if [ -n "$DEPLOYMENT_ID" ]; then
              echo "Found deployment ID: $DEPLOYMENT_ID"
              echo "Checking deployment status via Central Portal API..."

              # Create Bearer token from username:password
              AUTH_TOKEN=$(printf "%s:%s" "${{ env.JRELEASER_MAVENCENTRAL_USERNAME }}" "${{ env.JRELEASER_MAVENCENTRAL_PASSWORD }}" | base64)

              # Poll Portal API for deployment status (max 20 attempts, 30 seconds each = 10 minutes)
              MAX_RETRIES=20
              RETRY_COUNT=0

              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                RETRY_COUNT=$((RETRY_COUNT + 1))

                # Call Portal API status endpoint
                RESPONSE=$(curl -s -w "\n%{http_code}" \
                  -H "Authorization: Bearer ${AUTH_TOKEN}" \
                  "https://central.sonatype.com/api/v1/publisher/status?id=${DEPLOYMENT_ID}")

                HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
                BODY=$(echo "$RESPONSE" | sed '$d')

                if [ "$HTTP_CODE" == "200" ]; then
                  # Extract deploymentState from JSON response
                  DEPLOYMENT_STATE=$(echo "$BODY" | grep -o '"deploymentState":"[^"]*"' | cut -d'"' -f4)

                  echo "Attempt $RETRY_COUNT/$MAX_RETRIES: Deployment state is '$DEPLOYMENT_STATE'"

                  if [ "$DEPLOYMENT_STATE" == "PUBLISHED" ]; then
                    echo ""
                    echo "SUCCESS: Artifact published to Maven Central via Portal API"
                    echo "Portal: https://central.sonatype.com/artifact/${GROUP_ID}/${ARTIFACT_ID}/${VERSION}"
                    echo "Repository: https://repo1.maven.org/maven2/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}/"
                    exit 0
                  elif [ "$DEPLOYMENT_STATE" == "FAILED" ]; then
                    echo "ERROR: Deployment failed"
                    echo "$BODY"
                    exit 1
                  fi

                  # States: PENDING, VALIDATING, VALIDATED, PUBLISHING
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "Waiting 30 seconds before next check..."
                    sleep 30
                  fi
                else
                  echo "WARNING: Portal API returned HTTP $HTTP_CODE"
                  if [ "$HTTP_CODE" = "500" ]; then
                    echo "Note: HTTP 500 may indicate deployment is already completed/archived"
                  fi
                  echo "$BODY"
                  break
                fi
              done

              echo ""
              echo "Deployment not PUBLISHED after $MAX_RETRIES attempts (state: $DEPLOYMENT_STATE)"
              echo "This may be normal - falling back to direct Maven Central check..."
            else
              echo "WARNING: No deployment ID found in JReleaser output"
              echo "Falling back to direct Maven Central check..."
            fi
          else
            echo "WARNING: JReleaser output.properties not found at: $JRELEASER_OUTPUT"
            echo "Falling back to direct Maven Central check..."
          fi

          echo ""
          echo "Checking Maven Central repository directly..."
          MAVEN_CENTRAL_URL="https://repo1.maven.org/maven2/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.pom"
          echo "URL: ${MAVEN_CENTRAL_URL}"

          # Check repo1.maven.org with retries (max 10 attempts, 30 seconds each = 5 minutes)
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${MAVEN_CENTRAL_URL}")

            if [ "$HTTP_STATUS" == "200" ]; then
              echo ""
              echo "SUCCESS: Artifact confirmed on Maven Central repository"
              echo "Portal: https://central.sonatype.com/artifact/${GROUP_ID}/${ARTIFACT_ID}/${VERSION}"
              echo "Repository: https://repo1.maven.org/maven2/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}/"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Attempt $RETRY_COUNT/$MAX_RETRIES: Not available yet (HTTP $HTTP_STATUS). Waiting 30 seconds..."
              sleep 30
            fi
          done

          echo ""
          echo "WARNING: Artifact not confirmed after all checks"
          echo "This may be normal - Maven Central sync can take up to 2 hours"
          echo "Manual verification: ${MAVEN_CENTRAL_URL}"
          exit 0

      - name: Upload JReleaser logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: jreleaser-logs-${{ inputs.project-name }}
          path: |
            ${{ inputs.working-directory }}/build/jreleaser/
          retention-days: 5 