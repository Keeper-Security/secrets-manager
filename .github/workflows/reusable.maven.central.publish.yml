name: Reusable Maven Central Publishing

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for the Java project'
        required: true
        type: string
      project-name:
        description: 'Project name for SBOM generation'
        required: true
        type: string
      project-title:
        description: 'Human readable project title'
        required: true
        type: string
      java-version:
        description: 'Java version to use for building'
        required: false
        type: string
        default: '11'


jobs:
  get-version:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - name: Extract version from build.gradle.kts
        id: extract-version
        run: |
          VERSION=$(grep -Po 'version\s*=\s*"\K[^"]*' build.gradle.kts || echo "0.0.0-unknown")
          echo "Version retrieved: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  publish-to-maven-central:
    needs: get-version
    environment: prod
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Retrieve secrets from KSM
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@v1
        with:
          keeper-secret-config: ${{ secrets.KSM_ARTIFACT_JAVA_APP_CONFIG }}
          secrets: |
            IR14oITcuvFr9Ek-lKVrXw/file/90A46CD1-private-key.asc > file:/tmp/signing_secret_key_ring_file.asc
            IR14oITcuvFr9Ek-lKVrXw/custom_field/signing.keyId > env:SIGNING_KEY_ID
            IR14oITcuvFr9Ek-lKVrXw/custom_field/signing.password > env:SIGNING_PASSWORD
            GXzhWrjH4xVtfYvRKdX4Eg/field/login > env:MAVEN_USERNAME
            GXzhWrjH4xVtfYvRKdX4Eg/field/password > env:MAVEN_PASSWORD

      - name: Set up Java ${{ inputs.java-version }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'adopt'
          server-id: central
          server-username: ${{ env.MAVEN_USERNAME }}
          server-password: ${{ env.MAVEN_PASSWORD }}

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b

      - name: Publish to Maven Central
        env:
          SIGNING_SECRET_KEY_RING_FILE: /tmp/signing_secret_key_ring_file.asc
        run: |
          echo "Publishing ${{ inputs.project-title }} to Maven Central..."
          gradle publishToCentralPortal 