name: Publish to RubyGems (Ruby SDK)
on:
  workflow_dispatch:

jobs:
  test-ruby-sdk:
    name: Test Ruby SDK
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    defaults:
      run:
        working-directory: ./sdk/ruby

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          working-directory: ./sdk/ruby

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      - name: Run unit tests
        run: |
          bundle exec rspec spec/

      # Temporarily disabled - mock test has decryption issues with test data
      # - name: Run integration tests (mock mode)
      #   env:
      #     KEEPER_MOCK_MODE: 'true'
      #   run: |
      #     ruby -I lib test/integration/test_offline_mock.rb

      # Temporarily disabled - Docker image build fails in GitHub Actions CI environment
      # - name: Run Docker multi-version tests
      #   run: |
      #     ruby test/integration/docker_multi_version_test.rb

  generate-sbom:
    name: Generate SBOM
    needs: test-ruby-sdk
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./sdk/ruby

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          working-directory: ./sdk/ruby

      - name: Detect Ruby SDK version
        id: detect-version
        run: |
          if [ -f "lib/keeper_secrets_manager/version.rb" ]; then
            VERSION=$(ruby -r ./lib/keeper_secrets_manager/version.rb -e "puts KeeperSecretsManager::VERSION")
            echo "Detected version: ${VERSION}"
          else
            VERSION="1.0.0"
            echo "Could not detect version, using default: ${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build gem
        run: |
          echo "Building gem..."
          gem build keeper_secrets_manager.gemspec

          # Verify gem was created
          GEM_FILE=$(ls keeper_secrets_manager-*.gem)
          echo "Built gem: ${GEM_FILE}"

          # Display gem contents for verification
          echo "Gem contents:"
          gem spec ${GEM_FILE}

      - name: Install Syft and Manifest CLI
        run: |
          echo "Installing Syft v1.18.1..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /tmp/bin v1.18.1
          export PATH="/tmp/bin:$PATH"
          
          echo "Installing Manifest CLI v0.18.3..."
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b /tmp/bin v0.18.3

      - name: Generate and publish SBOM
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
          PROJECT_VERSION: ${{ steps.detect-version.outputs.version }}
        run: |
          export PATH="/tmp/bin:$PATH"

          # Find the built gem file
          GEM_FILE=$(ls keeper_secrets_manager-*.gem)
          echo "Scanning gem file: ${GEM_FILE}"

          echo "Generating SBOM from built gem with Manifest CLI..."
          /tmp/bin/manifest sbom "${GEM_FILE}" \
            --generator=syft \
            --name=keeper-secrets-manager-ruby-sdk \
            --version=${PROJECT_VERSION} \
            --output=spdx-json \
            --file=ruby-sdk-sbom.json \
            --api-key=${MANIFEST_TOKEN} \
            --publish=true \
            --asset-label=application,sbom-generated,ruby-gem,secrets-manager

          echo "SBOM generated and uploaded successfully: ruby-sdk-sbom.json"

          # Display SBOM summary for verification
          echo "SBOM Summary:"
          if [ -f ruby-sdk-sbom.json ]; then
            echo "Total packages: $(jq '.packages | length' ruby-sdk-sbom.json)"
            echo "Package names:"
            jq -r '.packages[] | .name' ruby-sdk-sbom.json | sort | uniq
          fi

      - name: Archive SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-ruby-sdk-${{ steps.detect-version.outputs.version }}
          path: ./sdk/ruby/ruby-sdk-sbom.json
          retention-days: 90

  publish-rubygems:
    name: Publish Ruby SDK to RubyGems
    environment: prod
    needs: [test-ruby-sdk, generate-sbom]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    defaults:
      run:
        working-directory: ./sdk/ruby

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          working-directory: ./sdk/ruby

      - name: Retrieve secrets from KSM
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: ${{ secrets.KSM_KSM_CONFIG }}
          secrets: |
            RQ7jXJ-r7WT2Cnq1nlFa6g/custom_field/RUBYGEMS_API_KEY > RUBYGEMS_API_KEY

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      - name: List files
        run: |
          pwd
          ls -lah

      - name: Build and verify gem
        run: |
          gem build keeper_secrets_manager.gemspec
          gem spec keeper_secrets_manager-*.gem

      - name: Publish to RubyGems
        env:
          GEM_HOST_API_KEY: ${{ steps.ksmsecrets.outputs.RUBYGEMS_API_KEY }}
        run: |
          gem push keeper_secrets_manager-*.gem 
