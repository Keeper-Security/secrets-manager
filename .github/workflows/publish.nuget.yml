name: Publish to NuGet and PowerShell Gallery

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to NuGet and PowerShell Gallery (uncheck to build only)'
        required: false
        default: 'true'
        type: boolean

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      sdk-version: ${{ steps.extract-sdk-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract SDK version
        id: extract-sdk-version
        working-directory: ./sdk/dotNet
        run: |
          VERSION=$(dotnet msbuild SecretsManager/SecretsManager.csproj -getProperty:PackageVersion)
          echo "SDK Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Generate and upload SBOM for SDK
  generate-sdk-sbom:
    needs: get-version
    uses: ./.github/workflows/reusable.sbom.workflow.yml
    with:
      working-directory: ./sdk/dotNet
      project-name: keeper-secrets-manager-dotnet
      project-type: dotnet
      project-version: ${{ needs.get-version.outputs.sdk-version }}
      sbom-format: spdx-json
      additional-labels: ksm,sdk,dotnet,security
    secrets:
      MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
  
  build-nuget:
    needs: generate-sdk-sbom
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./sdk/dotNet

    steps:
      - name: Get the source code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Install dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/sdk/dotNet/SecretsManager/bin/Release/*.nupkg

  publish-nuget:
    environment: prod
    needs: build-nuget
    if: ${{ github.event.inputs.publish == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./sdk/dotNet

    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-${{ github.run_number }}
          path: ./packages

      - name: Retrieve secrets from KSM
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: ${{ secrets.KSM_KSM_CONFIG }}
          secrets: |
            Sq4nnb5HXXNp1l6KryXynw/field/password > NUGET_AUTH_TOKEN

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Publish package
        run: dotnet nuget push ./packages/*.nupkg --api-key ${{steps.ksmsecrets.outputs.NUGET_AUTH_TOKEN}} --source https://api.nuget.org/v3/index.json

  build-powershell:
    needs: generate-sdk-sbom
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./sdk/dotNet

    steps:
      - name: Get the source code
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Install dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Package PowerShell module
        shell: pwsh
        run: |
          Set-Location ./SecretManagement.Keeper/
          ./build.ps1 -Package

      - name: Upload PowerShell packages
        uses: actions/upload-artifact@v4
        with:
          name: powershell-packages-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/sdk/dotNet/SecretManagement.Keeper/bin/Release/*.nupkg

  publish-powershell:
    environment: prod
    needs: build-powershell
    if: ${{ github.event.inputs.publish == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./sdk/dotNet

    steps:
      - name: Get the source code
        uses: actions/checkout@v4

      - name: Download PowerShell packages
        uses: actions/download-artifact@v4
        with:
          name: powershell-packages-${{ github.run_number }}
          path: ./packages

      - name: Retrieve secrets from KSM
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: ${{ secrets.KSM_KSM_CONFIG }}
          secrets: |
            FeE4uHTMEVJJhAdWK0ubMg/field/password > NUGET_AUTH_TOKEN

      - name: Publish package
        shell: pwsh
        working-directory: ./sdk/dotNet/SecretManagement.Keeper
        run: |
          ./build.ps1 -Publish -APIKey ${{steps.ksmsecrets.outputs.NUGET_AUTH_TOKEN}}
