name: Publish to PyPI (Python SDK & Helper)
on:
  workflow_dispatch:

jobs:
  # Extract versions for both SDK and Helper
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      sdk-version: ${{ steps.extract-sdk-version.outputs.version }}
      helper-version: ${{ steps.extract-helper-version.outputs.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Extract SDK version
        id: extract-sdk-version
        working-directory: ./sdk/python/core
        run: |
          VERSION=$(python3 setup.py --version 2>/dev/null || grep -Po 'version\s*=\s*["\x27]\K[^\x27"]*' setup.py)
          echo "SDK Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract Helper version
        id: extract-helper-version
        working-directory: ./sdk/python/helper
        run: |
          VERSION=$(python3 setup.py --version 2>/dev/null || grep -Po 'version\s*=\s*["\x27]\K[^\x27"]*' setup.py)
          echo "Helper Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Fail fast if either version is already on PyPI - before SBOM generation
  # and before the release manager is asked to approve anything.
  validate-versions:
    name: Validate versions not yet published
    needs: get-versions
    runs-on: ubuntu-latest
    steps:
      - name: Check SDK version not on PyPI
        run: |
          VERSION="${{ needs.get-versions.outputs.sdk-version }}"
          echo "Checking keeper-secrets-manager-core $VERSION..."
          if pip index versions keeper-secrets-manager-core 2>/dev/null | grep -qE "\b$VERSION\b"; then
            echo "::error::keeper-secrets-manager-core $VERSION is already on PyPI. Aborting."
            exit 1
          fi
          echo "keeper-secrets-manager-core $VERSION not yet on PyPI - ok to proceed"

      - name: Check Helper version not on PyPI
        run: |
          VERSION="${{ needs.get-versions.outputs.helper-version }}"
          echo "Checking keeper-secrets-manager-helper $VERSION..."
          if pip index versions keeper-secrets-manager-helper 2>/dev/null | grep -qE "\b$VERSION\b"; then
            echo "::error::keeper-secrets-manager-helper $VERSION is already on PyPI. Aborting."
            exit 1
          fi
          echo "keeper-secrets-manager-helper $VERSION not yet on PyPI - ok to proceed"

  # Generate and publish SBOM for SDK.
  # Uses pip --target to install only runtime deps into an isolated directory.
  # This excludes pip, wheel, setuptools and their internal dep trees from the
  # SBOM so that installer-tool CVEs don't appear as SDK vulnerabilities.
  generate-sdk-sbom:
    name: Generate and publish SDK SBOM
    needs: [get-versions, validate-versions]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install SDK from source into scan target
        run: |
          mkdir -p /tmp/sdk-scan-target
          pip3 install --quiet --target /tmp/sdk-scan-target ./sdk/python/core

      - name: Install Syft and Manifest CLI
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.32.0
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b /usr/local/bin v0.30.0

      - name: Generate and publish SDK SBOM
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
        run: |
          SCAN_TARGET=/tmp/sdk-scan-target
          VERSION="${{ needs.get-versions.outputs.sdk-version }}"

          echo "Scanning: $SCAN_TARGET"
          echo "Packages installed:"
          pip3 list --path "$SCAN_TARGET"

          manifest sbom "$SCAN_TARGET" \
            --generator=syft \
            --name=keeper-secrets-manager-python \
            --version="${VERSION}" \
            --output=spdx-json \
            --file=sdk-sbom.json \
            --api-key="${MANIFEST_TOKEN}" \
            --publish=true \
            --asset-label=ksm,sdk,python,security 2>&1 || \
          manifest sbom "$SCAN_TARGET" \
            --generator=syft \
            --name=keeper-secrets-manager-python \
            --version="${VERSION}" \
            --output=spdx-json \
            --file=sdk-sbom.json \
            --api-key="${MANIFEST_TOKEN}" \
            --publish=true \
            --label=ksm,sdk,python,security

      - name: Archive SDK SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-sdk-${{ needs.get-versions.outputs.sdk-version }}
          path: sdk-sbom.json
          retention-days: 90

  # Generate and publish SBOM for Helper.
  # Installs core from source first so this job has no dependency on core
  # being published to PyPI - both SBOM jobs run in parallel before the
  # release manager is asked to approve anything.
  # Uses pip --target to exclude installer-tool CVEs from the SBOM.
  generate-helper-sbom:
    name: Generate and publish Helper SBOM
    needs: [get-versions, validate-versions]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install SDK and Helper from source into scan target
        run: |
          mkdir -p /tmp/helper-scan-target
          # Install both in one call so pip resolves core locally instead of
          # hitting PyPI - core 17.2.0 isn't published yet at SBOM scan time.
          pip3 install --quiet --target /tmp/helper-scan-target \
            ./sdk/python/core ./sdk/python/helper

      - name: Install Syft and Manifest CLI
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v1.32.0
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b /usr/local/bin v0.30.0

      - name: Generate and publish Helper SBOM
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_TOKEN }}
        run: |
          SCAN_TARGET=/tmp/helper-scan-target
          VERSION="${{ needs.get-versions.outputs.helper-version }}"

          echo "Scanning: $SCAN_TARGET"
          echo "Packages installed:"
          pip3 list --path "$SCAN_TARGET"

          manifest sbom "$SCAN_TARGET" \
            --generator=syft \
            --name=keeper-secrets-manager-helper \
            --version="${VERSION}" \
            --output=spdx-json \
            --file=helper-sbom.json \
            --api-key="${MANIFEST_TOKEN}" \
            --publish=true \
            --asset-label=ksm,helper,python,security 2>&1 || \
          manifest sbom "$SCAN_TARGET" \
            --generator=syft \
            --name=keeper-secrets-manager-helper \
            --version="${VERSION}" \
            --output=spdx-json \
            --file=helper-sbom.json \
            --api-key="${MANIFEST_TOKEN}" \
            --publish=true \
            --label=ksm,helper,python,security

      - name: Archive Helper SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-helper-${{ needs.get-versions.outputs.helper-version }}
          path: helper-sbom.json
          retention-days: 90

  # Single publish job - both SDK and Helper publish under one environment: prod
  # gate so the release manager only presses the button once.
  # Both SBOM jobs must complete (and be verified by Manifest Cyber) before
  # this job runs.
  publish:
    name: Publish KSM Python SDK and Helper to PyPI
    needs: [generate-sdk-sbom, generate-helper-sbom, get-versions]
    environment: prod
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Get the source code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install build tools
        run: |
          python3 -m pip install --upgrade pip setuptools
          python3 -m pip install build twine 'wheel>=0.46.3'  # wheel pin: CVE-2026-24049

      # ── SDK ────────────────────────────────────────────────────────────────

      - name: Retrieve PyPI token from KSM (SDK)
        id: ksmsecrets-sdk
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: ${{ secrets.KSM_PYPI_PUBLISHER_PYPI_SDK_CONFIG }}
          secrets: |
            -aBWi3-yU_qvatNh0Eaqew/field/password > PYPI_API_TOKEN

      - name: Build and publish SDK
        working-directory: ./sdk/python/core
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ steps.ksmsecrets-sdk.outputs.PYPI_API_TOKEN }}
        run: |
          python3 -m build --no-isolation
          python3 -m twine upload --verbose dist/*

      # ── Helper ─────────────────────────────────────────────────────────────

      - name: Retrieve PyPI token from KSM (Helper)
        id: ksmsecrets-helper
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: ${{ secrets.KSM_PYPI_PUBLISHER_PYPI_SDK_CONFIG }}
          secrets: |
            -aBWi3-yU_qvatNh0Eaqew/field/password > PYPI_API_TOKEN

      - name: Build and publish Helper
        working-directory: ./sdk/python/helper
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ steps.ksmsecrets-helper.outputs.PYPI_API_TOKEN }}
        run: |
          python3 -m build --no-isolation
          python3 -m twine upload --verbose dist/*
